{{=<% %>=}}import { shallowMount, createLocalVue, Wrapper } from '@vue/test-utils'
import flushPromises from 'flush-promises'
import { createMockClient } from 'mock-apollo-client'
import VueApollo from 'vue-apollo'
import gql from 'graphql-tag'
import <%namePascalCase%>Form from '@/components/<%nameKebabCase%>/<%namePascalCase%>Form.vue'
import UniqueId from 'vue-unique-id'
import { MockApolloClient } from 'mock-apollo-client/dist/mockClient'

const localVue = createLocalVue()
localVue.use(UniqueId)
localVue.use(VueApollo)

describe('<%namePascalCase%>Form', () => {
  let wrapper: Wrapper<any>
  let mockClient: MockApolloClient
  let apolloProvider: VueApollo

  const createComponent = (props: any) => {
    mockClient = createMockClient()

    mockClient.setRequestHandler(gql`
      query <%nameCamelCase%>($id: Int) {
        <%nameCamelCase%>: <%nameCamelCase%>(id: $id) {
          id<%#each fields%>
          <%fieldNameCamelCase%><%/each%>
        }
      }
    `, jest.fn().mockResolvedValue({
      data: {
        <%nameCamelCase%>: {
          id: 1<%#each fields%>,
          <%fieldNameCamelCase%>: 'Some <%fieldNamePascalCase%>'<%/each%>
        }
      }
    }))

    apolloProvider = new VueApollo({
      defaultClient: mockClient
    })

    wrapper = shallowMount(<%namePascalCase%>Form, {
      localVue,
      apolloProvider,
      propsData: props
    })
  }

  afterEach(() => {
    wrapper.destroy()
  })

  it('is a Vue instance', () => {
    createComponent({ <%nameCamelCase%>Id: 1 })
    expect(wrapper.vm).toBeTruthy()
  })

  it('contains <%nameCamelCase%> form with no data if id is not set', () => {
    createComponent({ <%nameCamelCase%>Id: null })<%#each fields%>
    expect((wrapper.findComponent({ ref: '<%fieldNameCamelCase%>Input' }).element as HTMLInputElement).value).toContain('')<%/each%>
  })

  it('shows loading when fetching data if id is set', () => {
    createComponent({ <%nameCamelCase%>Id: 1 })
    expect(wrapper.text()).toContain('Loading...')
  })

  it('contains <%nameCamelCase%> form with data if id is set', async () => {
    createComponent({ <%nameCamelCase%>Id: 1 })
    await flushPromises()
<%#each fields%>
    expect((wrapper.findComponent({ ref: '<%fieldNameCamelCase%>Input' }).element as HTMLInputElement).value).toContain('Some <%fieldNamePascalCase%>')<%/each%>
  })

  it('emits edit event when edit is clicked', async () => {
    createComponent({ <%nameCamelCase%>Id: null })
    await flushPromises()
    await wrapper.findComponent({ ref: 'cancelBtn' }).trigger('click')
    expect(wrapper.emitted()['close:<%nameCamelCase%>Form']).toBeTruthy()
  })

  it('runs a mutation on submit and emits save event', async () => {
    createComponent({ <%nameCamelCase%>Id: 1 })
    await flushPromises()
    const queryHandler = jest.fn().mockResolvedValue(true)
    mockClient.setRequestHandler(gql`
      mutation save<%namePascalCase%>($<%nameCamelCase%>: <%namePascalCase%>Input!) {
        save<%namePascalCase%>(<%nameCamelCase%>: $<%nameCamelCase%>) {
          id<%#each fields%>
          <%fieldNameCamelCase%><%/each%>
        }
      }
    `, queryHandler)

    await wrapper.findComponent({ ref: '<%nameCamelCase%>Form' }).trigger('submit.prevent')
    expect(queryHandler).toBeCalledTimes(1)

    await wrapper.vm.$nextTick()
    expect(wrapper.emitted()['save:<%nameCamelCase%>']).toBeTruthy()
  })
})<%={{ }}=%>
