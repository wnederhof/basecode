package {{ groupId }}.{{ artifactId }}.{{ nameLowerCase }}

import {{ groupId }}.{{ artifactId }}.util.DynamicDataTransformer.withPropertyValuesOf
import {{ groupId }}.{{ artifactId }}.util.DynamicDataTransformer.learedProperties
import org.springframework.data.annotation.*
import org.springframework.data.relational.core.mapping.Table
import java.time.LocalDate
import java.time.LocalDateTime

@Table("{{ namePluralSnakeCase }}")
data class {{ namePascalCase }}(
    @Id
    val id: Int? = null{{#each fields }},
    val {{ fieldNameCamelCase }}: {{ fieldKotlinType }}{{/each}},

    @CreatedDate
    val createdAt: LocalDateTime? = null,

    @LastModifiedDate
    val updatedAt: LocalDateTime? = null
) {

    fun withUpdate(update{{ namePascalCase }}Input: Update{{ namePascalCase }}Input) = this
        .withPropertyValuesOf(update{{ namePascalCase }}Input)
        .withClearedProperties((update{{ namePascalCase }}Input.deletions ?: listOf()) - "id")

    companion object {
        fun newInstance(input: Create{{ namePascalCase }}Input) = {{ namePascalCase }}({{#each fields }}
            {{fieldNameCamelCase}} = input.{{fieldNameCamelCase}},{{/each}}
        )
    }

    data class Create{{ namePascalCase }}Input({{#each fields}}
        val {{ fieldNameCamelCase }}: {{ fieldKotlinType }},{{/each}}
    )

    data class Update{{ namePascalCase }}Input({{#each fields}}
        val {{ fieldNameCamelCase }}: {{ fieldKotlinTypeNotNullable }}?,{{/each}}{{#if hasNullableFields}}
        val deletions: List<String>? = null,{{/if}}
    )
{{#if hasRelations}}
    data class {{ namePascalCase }}FilterInput({{#each fields }}{{#if isFieldRelational}}
        val {{ fieldNameCamelCase }}: {{ fieldKotlinTypeNotNullable }}? = null,{{/if}}{{/each}}
    )
{{/if}}
}
