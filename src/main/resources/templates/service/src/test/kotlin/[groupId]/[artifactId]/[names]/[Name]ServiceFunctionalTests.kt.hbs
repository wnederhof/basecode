package {{ groupId }}.{{ artifactId }}.{{ names }}

import {{ groupId }}.{{ artifactId }}.IntegrationTestContext
import {{ groupId }}.{{ artifactId }}.{{ names }}.{{ Name }}Fixtures.{{ NAME }}_FIXTURE_1
{{#each fields as |f|}}{{#if fieldRelationship}}import {{ groupId }}.{{ artifactId }}.{{ fieldTypes }}.{{ FieldType }}Fixtures.{{ FIELD_TYPE }}_FIXTURE_1
import {{ groupId }}.{{ artifactId }}.{{ fieldTypes }}.{{ FieldType }}Service
{{/if}}{{/each}}
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired

class {{ Name }}ServiceFunctionalTests : IntegrationTestContext() {

    @Autowired
    private lateinit var {{ name }}Repository: {{ Name }}Repository

    @Autowired
    private lateinit var {{ name }}Service: {{ Name }}Service
{{#each fields as |f|}}{{#if fieldRelationship}}
    @Autowired
    private lateinit var {{ fieldType }}Service: {{ FieldType }}Service{{/if}}{{/each}}

    private lateinit var {{ name }}Fixture: {{ Name }}

    @BeforeEach
    fun setup() {
        {{ name }}Fixture = {{ name }}Repository.save({{ NAME }}_FIXTURE_1)
    }

    @Test
    fun `Multiple {{ names }} can be fetched at once`() {
        val {{ names }} = {{ name }}Service.findAll()

        assertThat({{ names }}).hasSize(1)
    }

    @Test
    fun `Saving an entity does not change the original`() {
        val unsaved{{ Name }} = {{ NAME }}_FIXTURE_1
        val copyOf{{ Name }} = unsaved{{ Name }}.copy()

        val saved{{ Name }} = {{ name }}Service.save(unsaved{{ Name }})

        assertThat(unsaved{{ Name }}).isEqualTo(copyOf{{ Name }})
        assertThat(saved{{ Name }}).isNotEqualTo({{ NAME }}_FIXTURE_1)
    }

    @Test
    fun `Retrieving non-existing {{ names }} yield null`() {
        assertThat({{ name }}Service.findById(0)).isNull()
    }

    @Test
    fun `{{ Names }} can be retrieved by id`() {
        assertThat({{ name }}Service.findById({{ name }}Fixture.id!!)).isNotNull
    }

    @Test
    fun `{{ Names }} can be deleted`() {
        {{ name }}Service.deleteById({{ name }}Fixture.id!!)

        assertThat({{ name }}Repository.findAll()).isEmpty()
    }
{{#each fields as |f|}}{{#if fieldRelationship}}
    @Test
    fun `Deleting a {{ fieldType }} causes its {{ names }} to be deleted as well`() {
        val {{ fieldType }} = {{ fieldType }}Service.save({{ FIELD_TYPE }}_FIXTURE_1)
        val {{ fieldName }} = {{ fieldType }}.id!!

        commentService.save({{ NAME }}_FIXTURE_1.copy({{ fieldName }} = {{ fieldName }}))
        postService.deleteById(postId)

        assertThat(commentService.findBy{{ FieldName }}({{ fieldName }})).isEmpty()
    }{{/if}}{{/each}}

}