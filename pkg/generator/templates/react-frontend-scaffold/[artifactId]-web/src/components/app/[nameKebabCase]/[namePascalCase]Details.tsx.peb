import { Modal } from '@components/shared/Modal'
import { DataDetails, DataDetailsField } from '@components/shared/DataDetails'
import { ErrorMessage } from '@components/shared/ErrorMessage'
import { gql, useQuery } from 'urql'
import { ActionSection } from "@components/shared/ActionSection";
import { useState, useMemo, ReactNode } from 'react'
import { {{ namePascalCase }}Editor } from '@components/app/{{ nameCamelCase }}/{{ namePascalCase }}Editor'
import { LoadingIndicator } from '@components/shared/LoadingIndicator'

const fields: DataDetailsField[] = [{%for field in fields%}
  {
    key: '{{ field.fieldNameCamelCase }}',
    label: '{{ field.fieldNamePascalCase }}',
    value: (data: any) => data.{{ field.fieldNameCamelCase }}
  },{%endfor%}
]

export interface {{ namePascalCase }}DetailsProps {
  id: string{%for field in fields%}{%if field.isFieldRelational%}
  {{ field.fieldNameCamelCase }}?: string{%endif%}{%endfor%}
  showHeader?: boolean
  showEdit?: boolean
  showBack?: boolean
  children?: ReactNode
}

export function {{ namePascalCase }}Details(props: {{ namePascalCase }}DetailsProps) {
  const [showEditor, setShowEditor] = useState(false)
  const [{ data, error, fetching }] = useQuery({
    query: gql`query {{nameCamelCase}}($id: ID!) {
      {{nameCamelCase}}(id: $id) {
        id{%for field in fields%}
        {{field.fieldNameCamelCase}}{%endfor%}
      }
    }`,
    variables: { id: props.id },
    context: useMemo(() => ({
      additionalTypenames: ['{{namePascalCase}}'],
    }), []),
  })
  if (error) {
    return (
      <ErrorMessage message={`Unable to load {{ namePluralCamelCase }}. Cause: ${error.message}`} />
    )
  }
  if (fetching) {
    return <LoadingIndicator />
  }
  return (
    <ActionSection
      header={props.showHeader ? "{{namePascalCase}} Details" : undefined}
      onEdit={props.showEdit ? () => setShowEditor(true) : undefined}
      onBack={props.showBack ? () => history.back() : undefined}
    >
      <DataDetails
        fields={fields}
        value={data.{{ nameCamelCase }}{{ "}" }}
      />
      {props.children}
      <Modal
        title="Edit {{namePascalCase}}"
        visible={{ "{" }}showEditor{{ "}" }}
      >
        <{{namePascalCase}}Editor
          id={props.id}{%for field in fields%}{%if field.isFieldRelational%}
          {{ field.fieldNameCamelCase }}={props.{{ field.fieldNameCamelCase }}{{ "}" }}{%endif%}{%endfor%}
          onSave={() => setShowEditor(false)}
          onCancel={() => setShowEditor(false)}
        />
      </Modal>
    </ActionSection>
  )
}